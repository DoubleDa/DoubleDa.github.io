<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="android,node.js,react native,ios,mongodb,weex,java"><title>Android Glide完全解析(下)：Glide源码解析 | 哒哒</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android Glide完全解析(下)：Glide源码解析</h1><a id="logo" href="/.">哒哒</a><p class="description">Keep engineers playfully</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Inicio</i></a><a href="/archives/"><i class="fa fa-archive"> Archivo</i></a><a href="/project/"><i class="fa fa-github"> project</i></a><a href="/resume/"><i class="fa fa-rss"> resume</i></a><a href="/about/"><i class="fa fa-user"> Acerca de</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Android Glide完全解析(下)：Glide源码解析</h1><div class="post-meta"><a href="/2017/10/19/glide-analyse-source-code/#comments" class="comment-count"></a><p><span class="date">Oct 19, 2017</span><span><a href="/categories/Android/" class="category">Android</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Golpes</i></i></span></p></div><div class="post-content"><p>Glide源码解析<br><a id="more"></a></p>
<h2 id="Glide总体设计"><a href="#Glide总体设计" class="headerlink" title="Glide总体设计"></a>Glide总体设计</h2><p><img src="http://oqle0m5m6.bkt.clouddn.com/Glide%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1.png" alt=""></p>
<h2 id="with"><a href="#with" class="headerlink" title="with()"></a>with()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">with(Context context)</div><div class="line">with(Activity activity)</div><div class="line">with(FragmentActivity activity)</div><div class="line">with(android.app.Fragment fragment)</div><div class="line">with(Fragment fragment)</div></pre></td></tr></table></figure>
<p>注意：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Any requests started using a context will only have the application level options applied and will not be started or stopped based on lifecycle events. In general, loads should be started at the level the result will be used in. If the resource will be used in a view in a child fragment,the load should be started with &#123;@link#with(android.app.Fragment)&#125;&#125; using that child fragment. Similarly,if the resource will be used in a view in the parent fragment, the load should be started with &#123;@link #with(android.app.Fragment)&#125; using the parent fragment. In the same vein, if the resource will be used in a view in an activity, the load should be started with &#123;@link #with(android.app.Activity)&#125;&#125;.</div></pre></td></tr></table></figure>
<p>Glide调用<code>with()</code>创建RequestManager对象，具体实现是通过调用RequestManagerRetriever对象的<code>get()</code>得到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(FragmentActivity activity)</span> </span>&#123;</div><div class="line">    RequestManagerRetriever retriever = RequestManagerRetriever.get();</div><div class="line">    <span class="keyword">return</span> retriever.get(activity);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>RequestManagerRetriever是一个为创建新的RequestManager或者从Activity和Fragment中检索已经存在的RequestManager提供静态方法的集合，在<code>RequestManagerRetriever.java</code>中具体实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(FragmentActivity activity)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Util.isOnBackgroundThread()) &#123;</div><div class="line">    	<span class="comment">/*</span></div><div class="line"><span class="comment">         * 子线程</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">return</span> get(activity.getApplicationContext());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    	<span class="comment">/*</span></div><div class="line"><span class="comment">         * UI线程</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="comment">//断言传入的上下文没被销毁(SDK&gt;=17)</span></div><div class="line">        assertNotDestroyed(activity);</div><div class="line">        FragmentManager fm = activity.getSupportFragmentManager();</div><div class="line">        <span class="keyword">return</span> supportFragmentGet(activity, fm);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在此还没有得到RequestManager，而真正得到RequestManager对象是通过<code>supportFragmentGet()</code>。首先，将传入的FragmentManager作为参数传入<code>getSupportRequestManagerFragment()</code>，获取SupportRequestManagerFragment对象；然后，SupportRequestManagerFragment对象调用<code>getRequestManager()</code>，获取RequestManager对象，并将其返回，如果RequestManager对象为空，创建RequestManager之后返回：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function">RequestManager <span class="title">supportFragmentGet</span><span class="params">(Context context, FragmentManager fm)</span> </span>&#123;</div><div class="line">    SupportRequestManagerFragment current = getSupportRequestManagerFragment(fm);</div><div class="line">    RequestManager requestManager = current.getRequestManager();</div><div class="line">    <span class="keyword">if</span> (requestManager == <span class="keyword">null</span>) &#123;</div><div class="line">        requestManager = <span class="keyword">new</span> RequestManager(context, current.getLifecycle(), current.getRequestManagerTreeNode());</div><div class="line">        current.setRequestManager(requestManager);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> requestManager;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="load"><a href="#load" class="headerlink" title="load()"></a>load()</h2><p>Glide调用<code>with()</code>之后创建了RequestManager对象，接下来调用<code>load()</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> DrawableTypeRequest&lt;String&gt; <span class="title">load</span><span class="params">(String string)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (DrawableTypeRequest&lt;String&gt;) fromString().load(string);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在此并没有进行<code>DrawableTypeRequest&lt;String&gt;</code>的真正创建，而是将其下发到：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> DrawableTypeRequest&lt;String&gt; <span class="title">fromString</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> loadGeneric(String.class);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再次下发到<code>loadGeneric()</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">DrawableTypeRequest&lt;T&gt; <span class="title">loadGeneric</span><span class="params">(Class&lt;T&gt; modelClass)</span> </span>&#123;</div><div class="line">    ModelLoader&lt;T, InputStream&gt; streamModelLoader = Glide.buildStreamModelLoader(modelClass, context);</div><div class="line">    ModelLoader&lt;T, ParcelFileDescriptor&gt; fileDescriptorModelLoader =</div><div class="line">            Glide.buildFileDescriptorModelLoader(modelClass, context);</div><div class="line">    <span class="keyword">if</span> (modelClass != <span class="keyword">null</span> &amp;&amp; streamModelLoader == <span class="keyword">null</span> &amp;&amp; fileDescriptorModelLoader == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown type "</span> + modelClass + <span class="string">". You must provide a Model of a type for"</span></div><div class="line">                + <span class="string">" which there is a registered ModelLoader, if you are using a custom model, you must first call"</span></div><div class="line">                + <span class="string">" Glide#register with a ModelLoaderFactory for your custom model class"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> optionsApplier.apply(</div><div class="line">            <span class="keyword">new</span> DrawableTypeRequest&lt;T&gt;(modelClass, streamModelLoader, fileDescriptorModelLoader, context,</div><div class="line">                    glide, requestTracker, lifecycle, optionsApplier));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着调用DrawableTypeRequest<string>的<code>into()</code>创建DrawableRequestBuilder<modeltype>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> DrawableRequestBuilder&lt;ModelType&gt; <span class="title">load</span><span class="params">(ModelType model)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.load(model);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></modeltype></string></p>
<p>而<code>load()</code>的实现落实到了<code>GenericRequestBuilder.java</code>的<code>load()</code>，此时GenericRequestBuilder对象创建成功：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> GenericRequestBuilder&lt;ModelType, DataType, ResourceType, TranscodeType&gt; <span class="title">load</span><span class="params">(ModelType model)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.model = model;</div><div class="line">    isModelSet = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="asBitmap"><a href="#asBitmap" class="headerlink" title="asBitmap()"></a>asBitmap()</h2><p>上文中Glide调用<code>load()</code>生成了GenericRequestBuilder对象。<code>asBitmap()</code>是DrawableTypeRequest类提供的创建BitmapTypeRequest对象的方法，而DrawableTypeRequest继承自DrawableRequestBuilder，而BitmapRequestBuilder又继承自GenericRequestBuilder。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> BitmapTypeRequest&lt;ModelType&gt; <span class="title">asBitmap</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> optionsApplier.apply(<span class="keyword">new</span> BitmapTypeRequest&lt;ModelType&gt;(<span class="keyword">this</span>, streamModelLoader,</div><div class="line">            fileDescriptorModelLoader, optionsApplier));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>BitmapTypeRequest具体的创建是通过RequestManager.OptionsApplier的<code>apply()</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;A, X extends GenericRequestBuilder&lt;A, ?, ?, ?&gt;&gt; <span class="function">X <span class="title">apply</span><span class="params">(X builder)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">        options.apply(builder);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> builder;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>apply()</code>中传入的对象为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">BitmapTypeRequest(GenericRequestBuilder&lt;ModelType, ?, ?, ?&gt; other,</div><div class="line">        ModelLoader&lt;ModelType, InputStream&gt; streamModelLoader,</div><div class="line">        ModelLoader&lt;ModelType, ParcelFileDescriptor&gt; fileDescriptorModelLoader,</div><div class="line">        RequestManager.OptionsApplier optionsApplier) &#123;</div><div class="line">    <span class="keyword">super</span>(buildProvider(other.glide, streamModelLoader, fileDescriptorModelLoader, Bitmap.class, <span class="keyword">null</span>),</div><div class="line">            Bitmap.class, other);</div><div class="line">    <span class="keyword">this</span>.streamModelLoader = streamModelLoader;</div><div class="line">    <span class="keyword">this</span>.fileDescriptorModelLoader = fileDescriptorModelLoader;</div><div class="line">    <span class="keyword">this</span>.glide = other.glide;</div><div class="line">    <span class="keyword">this</span>.optionsApplier = optionsApplier;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由此创建了BitmapTypeRequest对象。</p>
<h2 id="asGif"><a href="#asGif" class="headerlink" title="asGif()"></a>asGif()</h2><p>上文中Glide调用<code>load()</code>生成了GenericRequestBuilder对象。<code>asGif()</code>是DrawableTypeRequest类提供的创建GifTypeRequest对象的方法，而GifTypeRequest继承自GifRequestBuilder，而GifRequestBuilder又继承自GenericRequestBuilder。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> GifTypeRequest&lt;ModelType&gt; <span class="title">asGif</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> optionsApplier.apply(<span class="keyword">new</span> GifTypeRequest&lt;ModelType&gt;(<span class="keyword">this</span>, streamModelLoader, optionsApplier));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>GifTypeRequest具体的创建是通过RequestManager.OptionsApplier的<code>apply()</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;A, X extends GenericRequestBuilder&lt;A, ?, ?, ?&gt;&gt; <span class="function">X <span class="title">apply</span><span class="params">(X builder)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">        options.apply(builder);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> builder;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>apply()</code>中传入的对象为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">GifTypeRequest(GenericRequestBuilder&lt;ModelType, ?, ?, ?&gt; other,</div><div class="line">        ModelLoader&lt;ModelType, InputStream&gt; streamModelLoader, RequestManager.OptionsApplier optionsApplier) &#123;</div><div class="line">    <span class="keyword">super</span>(buildProvider(other.glide, streamModelLoader, GifDrawable.class, <span class="keyword">null</span>), GifDrawable.class, other);</div><div class="line">    <span class="keyword">this</span>.streamModelLoader = streamModelLoader;</div><div class="line">    <span class="keyword">this</span>.optionsApplier = optionsApplier;</div><div class="line">    <span class="comment">// Default to animating.</span></div><div class="line">    crossFade();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由此创建了GifTypeRequest对象。</p>
<h2 id="override"><a href="#override" class="headerlink" title="override()"></a>override()</h2><p>XxxTypeRequest中<code>override()</code>的具体实现落实到了<code>BitmapRequestBuilder.java</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> BitmapRequestBuilder&lt;ModelType, TranscodeType&gt; <span class="title">override</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.override(width, height);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>override()</code>的具体实现上传到父类实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> GenericRequestBuilder&lt;ModelType, DataType, ResourceType, TranscodeType&gt; <span class="title">override</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!Util.isValidDimensions(width, height)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Width and height must be Target#SIZE_ORIGINAL or &gt; 0"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.overrideWidth = width;</div><div class="line">    <span class="keyword">this</span>.overrideHeight = height;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由此创建了GenericRequestBuilder对象。</p>
<h2 id="error"><a href="#error" class="headerlink" title="error()"></a>error()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> BitmapRequestBuilder&lt;ModelType, TranscodeType&gt; <span class="title">error</span><span class="params">(<span class="keyword">int</span> resourceId)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.error(resourceId);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>具体实现上传到父类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> GenericRequestBuilder&lt;ModelType, DataType, ResourceType, TranscodeType&gt; <span class="title">error</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">        <span class="keyword">int</span> resourceId)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.errorId = resourceId;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由此创建了GenericRequestBuilder对象。</p>
<h2 id="placeholder"><a href="#placeholder" class="headerlink" title="placeholder()"></a>placeholder()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> BitmapRequestBuilder&lt;ModelType, TranscodeType&gt; <span class="title">placeholder</span><span class="params">(<span class="keyword">int</span> resourceId)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.placeholder(resourceId);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>具体实现由父类来完成：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> GenericRequestBuilder&lt;ModelType, DataType, ResourceType, TranscodeType&gt; <span class="title">placeholder</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">        <span class="keyword">int</span> resourceId)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.placeholderId = resourceId;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由此创建了GenericRequestBuilder对象。</p>
<h2 id="into"><a href="#into" class="headerlink" title="into()"></a>into()</h2><p>在GenericRequestBuilder子类XxxRequestBuilder中调用<code>into()</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Target&lt;TranscodeType&gt; <span class="title">into</span><span class="params">(ImageView view)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.into(view);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而具体的实现落实到了GenericRequestBuilder的<code>into()</code>,此<code>into()</code>取消已经加载到ImageView中的资源，以便ImageView能够被重用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Target&lt;TranscodeType&gt; <span class="title">into</span><span class="params">(ImageView view)</span> </span>&#123;</div><div class="line">    Util.assertMainThread();</div><div class="line">    <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must pass in a non null View"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!isTransformationSet &amp;&amp; view.getScaleType() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">switch</span> (view.getScaleType()) &#123;</div><div class="line">            <span class="keyword">case</span> CENTER_CROP:</div><div class="line">                applyCenterCrop();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> FIT_CENTER:</div><div class="line">            <span class="keyword">case</span> FIT_START:</div><div class="line">            <span class="keyword">case</span> FIT_END:</div><div class="line">                applyFitCenter();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//$CASES-OMITTED$</span></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="comment">// Do nothing.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> into(glide.buildImageViewTarget(view, transcodeClass));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>设置资源将被加载到的Target：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(Y target)</span> </span>&#123;</div><div class="line">	<span class="comment">//断言是否在UI线程</span></div><div class="line">    Util.assertMainThread();</div><div class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must pass in a non null Target"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!isModelSet) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must first set a model (try #load())"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//得到Target中的Request对象</span></div><div class="line">    Request previous = target.getRequest();</div><div class="line">    <span class="comment">//释放已有Request</span></div><div class="line">    <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">        previous.clear();</div><div class="line">        requestTracker.removeRequest(previous);</div><div class="line">        previous.recycle();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//重新生成Request</span></div><div class="line">    Request request = buildRequest(target);</div><div class="line">    <span class="comment">//设置Request</span></div><div class="line">    target.setRequest(request);</div><div class="line">    <span class="comment">//为Target添加监听器</span></div><div class="line">    lifecycle.addListener(target);</div><div class="line">    <span class="comment">//追踪已给的Request</span></div><div class="line">    requestTracker.runRequest(request);</div><div class="line">    <span class="keyword">return</span> target;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Glide中图片加载的请求统一由RequestTracker处理，两个数据结构requests、pendingRequests值得注意。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//使用Set集合来存储Request对象，并使用弱引用的对象</span></div><div class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Request&gt; requests = Collections.newSetFromMap(<span class="keyword">new</span> WeakHashMap&lt;Request, Boolean&gt;());</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//未完成或排队进行请求的集合</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Request&gt; pendingRequests = <span class="keyword">new</span> ArrayList&lt;Request&gt;();</div></pre></td></tr></table></figure></div><div class="tags"><a href="/tags/Glide源码解析/">Glide源码解析</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2017/10/20/eventbus-code-analyse/" class="pre">EventBus源码解析</a><a href="/2017/10/19/glide-use-simple/" class="next">Android Glide完全解析(上)：Glide用法</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contenidos</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Glide总体设计"><span class="toc-text">Glide总体设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#with"><span class="toc-text">with()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#load"><span class="toc-text">load()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#asBitmap"><span class="toc-text">asBitmap()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#asGif"><span class="toc-text">asGif()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#override"><span class="toc-text">override()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#error"><span class="toc-text">error()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#placeholder"><span class="toc-text">placeholder()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#into"><span class="toc-text">into()</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recientes</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/20/android-plugin-demo/">Android插件化框架VirtualAPK解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/20/android-use-realm/">Realm数据库使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/20/android-ndk-jni/">Android的JNI和NDK编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/20/android-hotfix/">Android热修复框架AndFix解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/20/android-component-demo/">Android项目组件化实战</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/20/android-custom-view/">Android自定义View实战</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/20/eventbus-code-analyse/">EventBus源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/19/glide-analyse-source-code/">Android Glide完全解析(下)：Glide源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/19/glide-use-simple/">Android Glide完全解析(上)：Glide用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/17/android-okhttp-down/">Android okhttp完全解析(下)：okhttp源码解析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> Categorías</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Etiquetas</i></div><div class="tagcloud"><a href="/tags/JNI和NDK/" style="font-size: 15px;">JNI和NDK</a> <a href="/tags/https接口/" style="font-size: 15px;">https接口</a> <a href="/tags/RxJava-MVP-Retrofit/" style="font-size: 15px;">RxJava MVP Retrofit</a> <a href="/tags/组件化/" style="font-size: 15px;">组件化</a> <a href="/tags/Android架构/" style="font-size: 15px;">Android架构</a> <a href="/tags/热修复/" style="font-size: 15px;">热修复</a> <a href="/tags/自定义View/" style="font-size: 15px;">自定义View</a> <a href="/tags/加固渠道/" style="font-size: 15px;">加固渠道</a> <a href="/tags/Glide源码解析/" style="font-size: 15px;">Glide源码解析</a> <a href="/tags/realm/" style="font-size: 15px;">realm</a> <a href="/tags/OkHttp用法/" style="font-size: 15px;">OkHttp用法</a> <a href="/tags/okhttp源码解析/" style="font-size: 15px;">okhttp源码解析</a> <a href="/tags/VirtualAPK/" style="font-size: 15px;">VirtualAPK</a> <a href="/tags/EventBus/" style="font-size: 15px;">EventBus</a> <a href="/tags/Glide用法/" style="font-size: 15px;">Glide用法</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archivo</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="https://guides.codepath.com/android" title="CodePath" target="_blank">CodePath</a><ul></ul><a href="https://realm.io/" title="Realm" target="_blank">Realm</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">RSS</a> |  <a href="/about/">Acerca de</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">dayongxin.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>