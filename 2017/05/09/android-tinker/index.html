<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="android,node.js,react native,ios,mongodb,weex,java"><title>Android热修复框架Tinker应用 | 哒哒</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android热修复框架Tinker应用</h1><a id="logo" href="/.">哒哒</a><p class="description">Keep engineers playfully</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Android热修复框架Tinker应用</h1><div class="post-meta"><a href="/2017/05/09/android-tinker/#comments" class="comment-count"></a><p><span class="date">May 09, 2017</span><span><a href="/categories/Android/" class="category">Android</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>Android热修复最近两年很火，本博客选择目前市面上功能最为强大、用户体量最大的热修复解决方案Tinker的用法进行讲解。</p>
<a id="more"></a>
<h2 id="Tinker简介"><a href="#Tinker简介" class="headerlink" title="Tinker简介"></a>Tinker简介</h2><p>Tinker是微信官方的Android热补丁解决方案，它支持动态下发代码、So库以及资源，让应用能够在不需要重新安装的情况下实现更新。微信亿级用户的考验，相信Tinker的可靠性还是不错。由于Tinker能够实现动态下发功能，小的功能和一些紧急需求也可以通过Tinker来实现。</p>
<p>Tinker主要包括三部分：</p>
<ul>
<li>gradle编译插件: tinker-patch-gradle-plugin</li>
</ul>
<p>在Android Studio中完成patch文件的生成</p>
<ul>
<li>核心sdk库: tinker-android-lib</li>
</ul>
<p>Tinker为应用程序提供的所有Api</p>
<ul>
<li>非gradle编译用户的命令行版本: tinker-patch-cli.jar</li>
</ul>
<p>与市面上其他的热修复方案相比(<a href="https://github.com/Tencent/tinker/wiki" target="_blank" rel="external">Tinker官网</a>)，Tinker有以下突出特点：</p>
<ul>
<li>支持so文件替换</li>
<li>性能损耗较少</li>
<li>支持gradle</li>
</ul>
<p>尽管Tinker相比其他热修复方案有比较突出的特点，但受限于原理与系统，有一些功能Tinker并不能支持：</p>
<ul>
<li>如果在<code>AndroidManifest.xml</code>中出现问题，或者新增功能在<code>AndroidManifest.xml</code>有修改，Tinker并不支持；</li>
<li>Tinker并不支持除了Activity、Service、BroadcastReceivber和ContentProvider四大组件之外的新增组件；</li>
<li>受限于Google Play开发者条款，在做Google Play渠道时Tinker并不能支持；</li>
<li>Android N的机器上应用的启动会受到Tinker的轻微影响；</li>
<li>不支持部分三星android-21机型，加载补丁时会主动抛出”TinkerRuntimeException:checkDexInstall failed”；</li>
<li>对于资源替换，不支持修改remoteView。例如transition动画，notification icon以及桌面图标;</li>
</ul>
<h2 id="简单集成Tinker"><a href="#简单集成Tinker" class="headerlink" title="简单集成Tinker"></a>简单集成Tinker</h2><h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>在项目级别的<code>build.gradle</code>中添加：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">        classpath (<span class="string">'com.tencent.tinker:tinker-patch-gradle-plugin:1.9.1'</span>)</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在Module级别的<code>build.gradle</code>中添加以下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line"> 	provided(<span class="string">'com.tencent.tinker:tinker-android-anno:1.9.1'</span>)</div><div class="line">    compile(<span class="string">'com.tencent.tinker:tinker-android-lib:1.9.1'</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment">//为了更好的控制Tinker的编译过程，添加以下代码：</span></div><div class="line"><span class="function">def <span class="title">buildWithTinker</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> rootProject.ext.tinkerEnabled</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(buildWithTinker())&#123;</div><div class="line">    apply plugin: <span class="string">'com.tencent.tinker.patch'</span></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 配置tinker相关的参数</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    tinkerPatch &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 编译相关的配置项</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        buildConfig &#123;</div><div class="line">            tinkerId=android.defaultConfig.versionCode</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>与此同时，需要在<code>AndroidManifest.xml</code>中添加tinker_id：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;meta-data</div><div class="line">    android:name=<span class="string">"TINKER_ID"</span></div><div class="line">    android:value=<span class="string">"tinker_id_100001"</span> /&gt;</div></pre></td></tr></table></figure></p>
<h3 id="初始化Tinker"><a href="#初始化Tinker" class="headerlink" title="初始化Tinker"></a>初始化Tinker</h3><p>新建<code>TinkerApplicationLike.java</code>类用于初始化Tinker：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@DefaultLifeCycle</span>(application = <span class="string">".MyTinkerApplication"</span>, flags = ShareConstants.TINKER_ENABLE_ALL, loadVerifyFlag = <span class="keyword">false</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TinkerApplicationLike</span> <span class="keyword">extends</span> <span class="title">ApplicationLike</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TinkerApplicationLike</span><span class="params">(Application application,</span></span></div><div class="line"><span class="function"><span class="params">                                 <span class="keyword">int</span> tinkerFlags,</span></span></div><div class="line"><span class="function"><span class="params">                                 <span class="keyword">boolean</span> tinkerLoadVerifyFlag,</span></span></div><div class="line"><span class="function"><span class="params">                                 <span class="keyword">long</span> applicationStartElapsedTime,</span></span></div><div class="line"><span class="function"><span class="params">                                 <span class="keyword">long</span> applicationStartMillisTime,</span></span></div><div class="line"><span class="function"><span class="params">                                 Intent tinkerResultIntent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(application,</div><div class="line">                tinkerFlags,</div><div class="line">                tinkerLoadVerifyFlag,</div><div class="line">                applicationStartElapsedTime,</div><div class="line">                applicationStartMillisTime,</div><div class="line">                tinkerResultIntent);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBaseContextAttached</span><span class="params">(Context base)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onBaseContextAttached(base);</div><div class="line">        <span class="comment">//初始化tinker</span></div><div class="line">        TinkerManager.installTinker(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="统一管理Tinker"><a href="#统一管理Tinker" class="headerlink" title="统一管理Tinker"></a>统一管理Tinker</h3><p>为了实现统一管理Tinker，新建一个<code>TinkerManager.java</code>的类实现对Tinker的统一管理，以便后面迭代和扩展功能：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TinkerManager</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 是否安装</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> isInstalled = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 声明ApplicationLike</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationLike mApplicationLike;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> mApplicationLike</span></div><div class="line"><span class="comment">     * <span class="doctag">@function</span> 完成tinker初始化</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">installTinker</span><span class="params">(ApplicationLike mApplicationLike)</span> </span>&#123;</div><div class="line">        mApplicationLike = mApplicationLike;</div><div class="line">        <span class="keyword">if</span> (isInstalled) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 1、安装Tinker（简单）</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        TinkerInstaller.install(mApplicationLike);</div><div class="line">        isInstalled = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadPatch</span><span class="params">(String patchPath, String md5Value)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Tinker.isTinkerInstalled()) &#123;</div><div class="line">            TinkerInstaller.onReceiveUpgradePatch(getTinkerContext(), patchPath);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     * <span class="doctag">@function</span> 获取tinker context对象</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Context <span class="title">getTinkerContext</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mApplicationLike != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> mApplicationLike.getApplication().getApplicationContext();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h3><p>首先需要在<code>MainActivity.java</code>中添加以下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 文件后缀名</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_END = <span class="string">".apk"</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * patch文件文件夹</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> String mPatchDir;</div><div class="line"><span class="comment">//1、初始化Patch文件夹</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initPatchDir</span><span class="params">()</span> </span>&#123;</div><div class="line">    mPatchDir = getExternalCacheDir().getAbsolutePath() + <span class="string">"/tpatch/"</span>;</div><div class="line">    File mFile = <span class="keyword">new</span> File(mPatchDir);</div><div class="line">    <span class="keyword">if</span> (mFile == <span class="keyword">null</span> || !mFile.exists()) &#123;</div><div class="line">        mFile.mkdir();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//2、获取patch文件路径</span></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getPatchFilePath</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mPatchDir.concat(<span class="string">"tinker"</span>).concat(FILE_END);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来，构建相关的Apk文件：</p>
<ul>
<li>构建一个旧Apk并安装到手机</li>
</ul>
<p>使用以下指令构建旧Apk：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./gradlew assembleRelease</div></pre></td></tr></table></figure></p>
<p>构建成功之后在目录<code>TinkerProject/app/build/outputs/apk</code>下找到旧Apk文件并进行保存。</p>
<ul>
<li>修改功能之后构建一个新Apk</li>
</ul>
<p>在旧Apk的功能之上进行修改，构建成功之后在目录<code>TinkerProject/app/build/outputs/apk</code>下找到新Apk文件并进行保存。</p>
<h3 id="Patch文件的生成"><a href="#Patch文件的生成" class="headerlink" title="Patch文件的生成"></a>Patch文件的生成</h3><ul>
<li>使用命令行</li>
</ul>
<p>首先，需要准备好Tinker生成Patch文件包：<br><img src="http://oqle0m5m6.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-11-12%20%E4%B8%8A%E5%8D%8812.42.56.png" alt=""><br>接着，使用以下指令生成Patch文件：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar tinker-patch-cli-<span class="number">1.7</span>.7.jar -old old.apk -<span class="keyword">new</span> <span class="keyword">new</span>.apk -config tinker_config.xml -out outputs</div></pre></td></tr></table></figure></p>
<p>生成Patch文件之后的目录：<br><img src="http://oqle0m5m6.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-11-12%20%E4%B8%8A%E5%8D%8812.51.45.png" alt=""><br>然后，将Patch文件<code>patch_signed.apk</code>推送到手机指定目录：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adb push patch_signed.apk /storage/emulated/<span class="number">0</span>/Android/data/com.dyx.tp/cache/tpatch/tinker.apk</div></pre></td></tr></table></figure></p>
<p>点击加载Patch文件按钮即可实现Patch文件的加载，重新启动App即可看到效果。</p>
<ul>
<li>使用Gradle方式</li>
</ul>
<p>首先，需要配置常量信息既可以在项目根目录的<code>config.gradle</code>中配置，也可以在Module目录下的<code>build.gradle</code>中配置，具体代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 常量配置</span></div><div class="line"><span class="comment"> */</span></div><div class="line">ext &#123;</div><div class="line">    <span class="comment">//启用tinker</span></div><div class="line">    tinkerEnabled = <span class="keyword">true</span></div><div class="line">    <span class="comment">//oldApk路径</span></div><div class="line">    oldApkPath = <span class="string">"$&#123;bakPath&#125;/app-0701-16-48-51"</span></div><div class="line">    <span class="comment">//applyMapping文件路径</span></div><div class="line">    applyMappingPath = <span class="string">"$&#123;bakPath&#125;/app-0701-16-48-51"</span></div><div class="line">    <span class="comment">//applyResourceMapping文件路径</span></div><div class="line">    applyResourceMapping = <span class="string">"$&#123;bakPath&#125;/app-0701-16-48-51"</span></div><div class="line">    <span class="comment">//tinkerId</span></div><div class="line">    tinkerId = <span class="string">"100001"</span></div><div class="line">    <span class="comment">//tinker patch渠道包生成路径</span></div><div class="line">    tinkerBuildFlavorDirectory = <span class="string">"$&#123;bakPath&#125;/app-0701-16-48-51"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着，需要Tinker生成Patch文件的相关配置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取Tinker多渠道包</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">def <span class="title">getTinkerBuildFlavorDirectory</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ext.tinkerBuildFlavorDirectory</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 判断当前是否使用了Tinker</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">def <span class="title">buildWithTinker</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ext.tinkerEnabled</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取old apk文件路径</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">def <span class="title">getOldApkPath</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ext.oldApkPath</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取applyMapping文件路径</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">def <span class="title">getApplyMappingPath</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ext.applyMappingPath</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取applyResourceMapping文件路径</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">def <span class="title">getApplyResourceMappingPath</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ext.applyResourceMapping</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 获取tinkerId</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">def <span class="title">getTinkerIdValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ext.tinkerId</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后，配置在使用Tinker构建项目时的属性：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (buildWithTinker()) &#123;</div><div class="line">    <span class="comment">//是否启用tinker</span></div><div class="line">    apply plugin: <span class="string">'com.tencent.tinker.patch'</span></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 配置tinker相关的参数</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    tinkerPatch &#123;</div><div class="line">        <span class="comment">//指定oldApk路径</span></div><div class="line">        oldApk = getOldApkPath()</div><div class="line">        <span class="comment">//配置ignoreWarning：不忽略tinker的警告，如果出现警告就终止tinker生成patch文件</span></div><div class="line">        ignoreWarning = <span class="keyword">false</span></div><div class="line">        <span class="comment">//是否使用签名</span></div><div class="line">        useSign = <span class="keyword">true</span></div><div class="line">        <span class="comment">//是否启用tinker</span></div><div class="line">        tinkerEnable = buildWithTinker()</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 编译相关的配置项</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        buildConfig &#123;</div><div class="line">            <span class="comment">//获取applyMapping文件路径</span></div><div class="line">            applyMapping = getApplyMappingPath()</div><div class="line">            <span class="comment">//获取applyResourceMapping文件路径</span></div><div class="line">            applyResourceMapping = getApplyResourceMappingPath()</div><div class="line">            <span class="comment">//设置tinkerId</span></div><div class="line">            tinkerId = getTinkerIdValue()</div><div class="line">            <span class="comment">//如果我们有多个dex,编译补丁时可能会由于类的移动导致变更增多。若打开keepDexApply模式，补丁包将根据基准包的类分布来编译。</span></div><div class="line">            keepDexApply = <span class="keyword">false</span></div><div class="line">            <span class="comment">//是否使用加固模式，仅仅将变更的类合成补丁。注意，这种模式仅仅可以用于加固应用中。</span></div><div class="line">            isProtectedApp = <span class="keyword">false</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * dex相关的配置项</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        dex &#123;</div><div class="line">            <span class="comment">//设置dexMode：对于'raw'模式，我们将会保持输入dex的格式。对于'jar'模式，我们将会把输入dex重新压缩封装到jar。</span></div><div class="line">            dexMode = <span class="string">"jar"</span></div><div class="line">            <span class="comment">//设置pattern：指定tinker要处理的dex文件位于哪些目录</span></div><div class="line">            pattern = [<span class="string">"classes*.dex"</span>,</div><div class="line">                       <span class="string">"assets/secondary-dex-?.jar"</span>]</div><div class="line">            <span class="comment">//设置loader：指定加载patch文件用到的类</span></div><div class="line">            loader = [<span class="string">"com.dyx.td.tinker.MyTinkerApplication"</span>]</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * lib相关的配置项</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        lib &#123;</div><div class="line">            <span class="comment">//指定lib、.so包的路径</span></div><div class="line">            pattern = [<span class="string">"lib/*/*.so"</span>]</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * res相关的配置项</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        res &#123;</div><div class="line">            <span class="comment">//资源文件路径</span></div><div class="line">            pattern = [<span class="string">"res/*"</span>, <span class="string">"assets/*"</span>, <span class="string">"resources.arsc"</span>, <span class="string">"AndroidManifest.xml"</span>]</div><div class="line">            <span class="comment">//设置ignoreChange</span></div><div class="line">            ignoreChange = [<span class="string">"assets/sample_meta.txt"</span>]</div><div class="line">            <span class="comment">//设置largeModSize</span></div><div class="line">            largeModSize = <span class="number">100</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 用于生成补丁包中的'package_meta.txt'文件</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        packageConfig &#123;</div><div class="line">            configField(<span class="string">"patchMessage"</span>, <span class="string">"tinker is sample to use"</span>)</div><div class="line">            configField(<span class="string">"platform"</span>, <span class="string">"all"</span>)</div><div class="line">            configField(<span class="string">"patchVersion"</span>, <span class="string">"1.0"</span>)</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * 7zip路径配置项，执行前提是useSign为true</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        sevenZip &#123;</div><div class="line">            <span class="comment">//例如"com.tencent.mm:SevenZip:1.1.10"，将自动根据机器属性获得对应的7za运行文件，推荐使用。</span></div><div class="line">            zipArtifact = <span class="string">"com.tencent.mm:SevenZip:1.1.10"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 检查是否配置了多渠道</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    List&lt;String&gt; flavors = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    project.android.productFlavors.each &#123; flavor -&gt;</div><div class="line">        flavors.add(flavor.name)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">boolean</span> hasFlavors = flavors.size() &gt; <span class="number">0</span></div><div class="line">    def date = <span class="keyword">new</span> Date().format(<span class="string">"MMdd-HH-mm-ss"</span>)</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * bak apk and mapping</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    android.applicationVariants.all &#123; variant -&gt;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * task type, you want to bak</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        def taskName = variant.name</div><div class="line">        tasks.all &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"assemble$&#123;taskName.capitalize()&#125;"</span>.equalsIgnoreCase(it.name)) &#123;</div><div class="line">                it.doLast &#123;</div><div class="line">                    copy &#123;</div><div class="line">                        def fileNamePrefix = <span class="string">"$&#123;project.name&#125;-$&#123;variant.baseName&#125;"</span></div><div class="line">                        def newFileNamePrefix = hasFlavors ? <span class="string">"$&#123;fileNamePrefix&#125;"</span> : <span class="string">"$&#123;fileNamePrefix&#125;-$&#123;date&#125;"</span></div><div class="line">                        def destPath = hasFlavors ? file(<span class="string">"$&#123;bakPath&#125;/$&#123;project.name&#125;-$&#123;date&#125;/$&#123;variant.flavorName&#125;"</span>) : bakPath</div><div class="line">                        from variant.outputs.outputFile</div><div class="line">                        into destPath</div><div class="line">                        rename &#123; String fileName -&gt;</div><div class="line">                            fileName.replace(<span class="string">"$&#123;fileNamePrefix&#125;.apk"</span>, <span class="string">"$&#123;newFileNamePrefix&#125;.apk"</span>)</div><div class="line">                        &#125;</div><div class="line">                        from <span class="string">"$&#123;buildDir&#125;/outputs/mapping/$&#123;variant.dirName&#125;/mapping.txt"</span></div><div class="line">                        into destPath</div><div class="line">                        rename &#123; String fileName -&gt;</div><div class="line">                            fileName.replace(<span class="string">"mapping.txt"</span>, <span class="string">"$&#123;newFileNamePrefix&#125;-mapping.txt"</span>)</div><div class="line">                        &#125;</div><div class="line">                        from <span class="string">"$&#123;buildDir&#125;/intermediates/symbols/$&#123;variant.dirName&#125;/R.txt"</span></div><div class="line">                        into destPath</div><div class="line">                        rename &#123; String fileName -&gt;</div><div class="line">                            fileName.replace(<span class="string">"R.txt"</span>, <span class="string">"$&#123;newFileNamePrefix&#125;-R.txt"</span>)</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 生成渠道包</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    project.afterEvaluate &#123;</div><div class="line">        <span class="comment">//sample use for build all flavor for one time</span></div><div class="line">        <span class="keyword">if</span> (hasFlavors) &#123;</div><div class="line">            task(tinkerPatchAllFlavorRelease) &#123;</div><div class="line">                group = <span class="string">'tinker'</span></div><div class="line">                def originOldPath = getTinkerBuildFlavorDirectory()</div><div class="line">                <span class="keyword">for</span> (String flavor : flavors) &#123;</div><div class="line">                    def tinkerTask = tasks.getByName(<span class="string">"tinkerPatch$&#123;flavor.capitalize()&#125;Release"</span>)</div><div class="line">                    dependsOn tinkerTask</div><div class="line">                    def preAssembleTask = tasks.getByName(<span class="string">"process$&#123;flavor.capitalize()&#125;ReleaseManifest"</span>)</div><div class="line">                    preAssembleTask.doFirst &#123;</div><div class="line">                        String flavorName = preAssembleTask.name.substring(<span class="number">7</span>, <span class="number">8</span>).toLowerCase() + preAssembleTask.name.substring(<span class="number">8</span>, preAssembleTask.name.length() - <span class="number">15</span>)</div><div class="line">                        project.tinkerPatch.oldApk = <span class="string">"$&#123;originOldPath&#125;/$&#123;flavorName&#125;/$&#123;project.name&#125;-$&#123;flavorName&#125;-release.apk"</span></div><div class="line">                        project.tinkerPatch.buildConfig.applyMapping = <span class="string">"$&#123;originOldPath&#125;/$&#123;flavorName&#125;/$&#123;project.name&#125;-$&#123;flavorName&#125;-release-mapping.txt"</span>                      project.tinkerPatch.buildConfig.applyResourceMapping = <span class="string">"$&#123;originOldPath&#125;/$&#123;flavorName&#125;/$&#123;project.name&#125;-$&#123;flavorName&#125;-release-R.txt"</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            task(tinkerPatchAllFlavorDebug) &#123;</div><div class="line">                group = <span class="string">'tinker'</span></div><div class="line">                def originOldPath = getTinkerBuildFlavorDirectory()</div><div class="line">                <span class="keyword">for</span> (String flavor : flavors) &#123;</div><div class="line">                    def tinkerTask = tasks.getByName(<span class="string">"tinkerPatch$&#123;flavor.capitalize()&#125;Debug"</span>)</div><div class="line">                    dependsOn tinkerTask</div><div class="line">                    def preAssembleTask = tasks.getByName(<span class="string">"process$&#123;flavor.capitalize()&#125;DebugManifest"</span>)</div><div class="line">                    preAssembleTask.doFirst &#123;</div><div class="line">                        String flavorName = preAssembleTask.name.substring(<span class="number">7</span>, <span class="number">8</span>).toLowerCase() + preAssembleTask.name.substring(<span class="number">8</span>, preAssembleTask.name.length() - <span class="number">13</span>)</div><div class="line">                        project.tinkerPatch.oldApk = <span class="string">"$&#123;originOldPath&#125;/$&#123;flavorName&#125;/$&#123;project.name&#125;-$&#123;flavorName&#125;-debug.apk"</span></div><div class="line">                        project.tinkerPatch.buildConfig.applyMapping = <span class="string">"$&#123;originOldPath&#125;/$&#123;flavorName&#125;/$&#123;project.name&#125;-$&#123;flavorName&#125;-debug-mapping.txt"</span></div><div class="line">                        project.tinkerPatch.buildConfig.applyResourceMapping = <span class="string">"$&#123;originOldPath&#125;/$&#123;flavorName&#125;/$&#123;project.name&#125;-$&#123;flavorName&#125;-debug-R.txt"</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Tinker高级应用"><a href="#Tinker高级应用" class="headerlink" title="Tinker高级应用"></a>Tinker高级应用</h2><p>在实际的项目中，我们不可能通过简单实用Tinker的方式来进行热更新操作，我们需要自定义Patch文件检测、更新、下载、校验和加载等任务模块。</p>
<p><img src="http://oqle0m5m6.bkt.clouddn.com/%E7%83%AD%E6%9B%B4%E6%96%B0%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%20%281%29.png" width="288" height="512" align="center"></p>
<h3 id="实现TinkerService"><a href="#实现TinkerService" class="headerlink" title="实现TinkerService"></a>实现TinkerService</h3><p>首先，实现检测服务器是否有下发Patch文件的指令，如果有并且本地App还未安装就进行下载操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TinkerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 检测更新patch</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UPDATE_PATCH = <span class="number">0x01</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 下载patch</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DOWNLOAD_PATCH = <span class="number">0x02</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * patch文件结尾</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_END = <span class="string">".apk"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 存放文件的文件夹</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String mPatchFileDir;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 存放文件的文件名</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> String mPatchFile;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * PatchInfoModel</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> PatchInfoModel mPatchInfoModel;</div><div class="line">    <span class="keyword">private</span> Handler mHandler = <span class="keyword">new</span> Handler() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> UPDATE_PATCH:</div><div class="line">                    checkPatchInfo();</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> DOWNLOAD_PATCH:</div><div class="line">                    downloadPatch();</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">downloadPatch</span><span class="params">()</span> </span>&#123;</div><div class="line">        mPatchFile = mPatchFileDir.concat(String.valueOf(System.currentTimeMillis())).concat(FILE_END);</div><div class="line">HttpClientManager.getInstance().downloadPatch(mPatchInfoModel.getPatchUrl(), mPatchFile, <span class="keyword">new</span> DownloadListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String successMsg)</span> </span>&#123;</div><div class="line">                TinkerManager.loadPatch(mPatchFile, successMsg);</div><div class="line">            &#125;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailed</span><span class="params">(String failedMsg)</span> </span>&#123;</div><div class="line">                stopSelf();</div><div class="line">            &#125;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onProgress</span><span class="params">(<span class="keyword">int</span> progressMsg)</span> </span>&#123;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkPatchInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">        HttpClientManager.getInstance().checkPatchInfo(<span class="keyword">new</span> HttpListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Object successMsg)</span> </span>&#123;</div><div class="line">                mPatchInfoModel = (PatchInfoModel) successMsg;</div><div class="line">                mHandler.sendEmptyMessage(DOWNLOAD_PATCH);</div><div class="line">            &#125;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailed</span><span class="params">(Object failedMsg)</span> </span>&#123;</div><div class="line">                stopSelf();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 初始化patch文件存储目录</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        mPatchFileDir = getExternalCacheDir().getAbsolutePath() + <span class="string">"/tpatch/"</span>;</div><div class="line">        File mFile = <span class="keyword">new</span> File(mPatchFileDir);</div><div class="line">        <span class="keyword">if</span> (mFile == <span class="keyword">null</span> || !mFile.exists()) &#123;</div><div class="line">            mFile.mkdir();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        <span class="comment">//检查是否有patch文件</span></div><div class="line">        mHandler.sendEmptyMessage(UPDATE_PATCH);</div><div class="line">        <span class="keyword">return</span> START_NOT_STICKY;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="自定义Patch文件监听"><a href="#自定义Patch文件监听" class="headerlink" title="自定义Patch文件监听"></a>自定义Patch文件监听</h3><p>Patch文件下载完成之后，为了验证Patch文件是否被篡改需要对其进行MD5校验等验证安全性操作，就需要自定义相关流程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//1、校验patch文件是否合法；2、启动Service去安装patch文件；</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomPatchListener</span> <span class="keyword">extends</span> <span class="title">DefaultPatchListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String currentFileMD5;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCurrentFileMD5</span><span class="params">(String currentFileMD5)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.currentFileMD5 = currentFileMD5;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomPatchListener</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">patchCheck</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">        <span class="comment">//patch文件MD5校验</span></div><div class="line">        <span class="keyword">if</span> (!Utils.isFileMD5Matched(path, currentFileMD5)) &#123;</div><div class="line">            <span class="keyword">return</span> ShareConstants.ERROR_PATCH_DISABLE;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.patchCheck(path);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>自定义完Patch文件校验、安装等流程之后，就可以在<code>TinkerManager.java</code>中进行应用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 声明CustomPatchListener</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> CustomPatchListener mCustomPatchListener;</div><div class="line"><span class="comment">//创建CustomPatchListener</span></div><div class="line">mCustomPatchListener = <span class="keyword">new</span> CustomPatchListener(getTinkerContext());</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 2、安装Tinker（复杂）</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">//创建LoadReporter对象：patch加载阶段</span></div><div class="line">LoadReporter mLoadReporter = <span class="keyword">new</span> DefaultLoadReporter(getTinkerContext());</div><div class="line"><span class="comment">//创建PatchReporter对象：patch合成阶段</span></div><div class="line">PatchReporter mPatchReporter = <span class="keyword">new</span> DefaultPatchReporter(getTinkerContext());</div><div class="line"><span class="comment">//创建AbstractPatch对象</span></div><div class="line">AbstractPatch mAbstractPatch = <span class="keyword">new</span> UpgradePatch();</div><div class="line"><span class="comment">//安装Tinker</span></div><div class="line">TinkerInstaller.install(mApplicationLike,</div><div class="line">        mLoadReporter,</div><div class="line">        mPatchReporter,</div><div class="line">        mCustomPatchListener,</div><div class="line">        CustomResultService.class,</div><div class="line">        mAbstractPatch);</div><div class="line"><span class="comment">//加载Patch之前进行文件校验</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadPatch</span><span class="params">(String patchPath, String md5Value)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Tinker.isTinkerInstalled()) &#123;</div><div class="line">        <span class="comment">//进行patch文件校验</span></div><div class="line">        mCustomPatchListener.setCurrentFileMD5(md5Value);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="自定义Patch文件加载状态"><a href="#自定义Patch文件加载状态" class="headerlink" title="自定义Patch文件加载状态"></a>自定义Patch文件加载状态</h3><p>到底Patch文件有木有加载成功，亦或者Patch文件加载失败了，到底是哪一步失败？需要继承自<code>DefaultTinkerResultService</code>的自定义类<code>CustomResultService.java</code>来实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomResultService</span> <span class="keyword">extends</span> <span class="title">DefaultTinkerResultService</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 返回patch文件安装结果</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> result</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPatchResult</span><span class="params">(PatchResult result)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">            Logger.d(<span class="string">"DefaultTinkerResultService received null result!!!!"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        Logger.d(<span class="string">"DefaultTinkerResultService received a result:"</span> + result.toString());</div><div class="line">TinkerServiceInternals.killTinkerPatchServiceProcess(getApplicationContext());</div><div class="line">        <span class="keyword">if</span> (result.isSuccess) &#123;</div><div class="line">            deleteRawPatchFile(<span class="keyword">new</span> File(result.rawPatchFilePath));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/Tinker/">Tinker</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2017/05/27/android-ndk-jni/" class="pre">Android的JNI和NDK编程</a><a href="/2017/04/17/android-component-demo/" class="next">Android项目组件化实战</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tinker简介"><span class="toc-text">Tinker简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简单集成Tinker"><span class="toc-text">简单集成Tinker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#添加依赖"><span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化Tinker"><span class="toc-text">初始化Tinker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#统一管理Tinker"><span class="toc-text">统一管理Tinker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#准备阶段"><span class="toc-text">准备阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Patch文件的生成"><span class="toc-text">Patch文件的生成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tinker高级应用"><span class="toc-text">Tinker高级应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实现TinkerService"><span class="toc-text">实现TinkerService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义Patch文件监听"><span class="toc-text">自定义Patch文件监听</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义Patch文件加载状态"><span class="toc-text">自定义Patch文件加载状态</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/09/butterknife-analyze/">ButterKnife的使用及其解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/07/retrofit-base-advance/">Android Retrofit完全解析(下)：Retrofit源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/27/retrofit-base-use/">Android Retrofit完全解析(上)：Retrofit用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/rxjava-high-use/">RxJava高阶用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/12/rxjava-base-use/">RxJava基本用法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/builder-pattern/">设计模式之建造者模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/13/android-use-realm/">Realm数据库使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/27/android-ndk-jni/">Android的JNI和NDK编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/09/android-tinker/">Android热修复框架Tinker应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/17/android-component-demo/">Android项目组件化实战</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Design-pattern/">Design pattern</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/RxJava/">RxJava</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/ButterKnife解析/" style="font-size: 15px;">ButterKnife解析</a> <a href="/tags/加固渠道/" style="font-size: 15px;">加固渠道</a> <a href="/tags/Android架构/" style="font-size: 15px;">Android架构</a> <a href="/tags/自定义View/" style="font-size: 15px;">自定义View</a> <a href="/tags/组件化/" style="font-size: 15px;">组件化</a> <a href="/tags/Jni和Ndk/" style="font-size: 15px;">Jni和Ndk</a> <a href="/tags/OkHttp源码解析/" style="font-size: 15px;">OkHttp源码解析</a> <a href="/tags/Realm/" style="font-size: 15px;">Realm</a> <a href="/tags/建造者模式/" style="font-size: 15px;">建造者模式</a> <a href="/tags/OkHttp用法/" style="font-size: 15px;">OkHttp用法</a> <a href="/tags/Tinker/" style="font-size: 15px;">Tinker</a> <a href="/tags/适配器模式/" style="font-size: 15px;">适配器模式</a> <a href="/tags/Glide用法/" style="font-size: 15px;">Glide用法</a> <a href="/tags/Https接口/" style="font-size: 15px;">Https接口</a> <a href="/tags/Glide源码解析/" style="font-size: 15px;">Glide源码解析</a> <a href="/tags/RecyclerView/" style="font-size: 15px;">RecyclerView</a> <a href="/tags/Retrofit解析/" style="font-size: 15px;">Retrofit解析</a> <a href="/tags/观察者模式/" style="font-size: 15px;">观察者模式</a> <a href="/tags/RxJava-MVP-Retrofit/" style="font-size: 15px;">RxJava MVP Retrofit</a> <a href="/tags/Retrofit/" style="font-size: 15px;">Retrofit</a> <a href="/tags/RxJava/" style="font-size: 15px;">RxJava</a> <a href="/tags/单例模式/" style="font-size: 15px;">单例模式</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://guides.codepath.com/android" title="CodePath" target="_blank">CodePath</a><ul></ul><a href="https://realm.io/" title="Realm" target="_blank">Realm</a><ul></ul><a href="https://developer.android.google.cn/index.html" title="Google Android" target="_blank">Google Android</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">dayongxin.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>